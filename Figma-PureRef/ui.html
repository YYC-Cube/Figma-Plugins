<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Figma PureRef</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f5f5f5;
      color: #1a1a1a;
      line-height: 1.6;
    }

    .container {
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1a1a1a;
    }

    h2 {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 10px;
      color: #333333;
    }

    .section {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .btn {
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .btn:hover {
      background-color: #0052a3;
    }

    .btn-secondary {
      background-color: #666666;
    }

    .btn-secondary:hover {
      background-color: #525252;
    }

    .btn-danger {
      background-color: #dc3545;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .cleanup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .cleanup-card {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .cleanup-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-color: #0066cc;
    }

    .cleanup-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .cleanup-description {
      font-size: 12px;
      color: #666666;
      margin-bottom: 8px;
    }

    .severity-badge {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
    }

    .severity-low {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .severity-medium {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    .severity-high {
      background-color: #ffebee;
      color: #c62828;
    }

    .refactor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .refactor-card {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .refactor-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-color: #0066cc;
    }

    .refactor-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .refactor-description {
      font-size: 12px;
      color: #666666;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }

    .status-message {
      background-color: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
    }

    .error-message {
      background-color: #ffebee;
      color: #c62828;
      border-radius: 4px;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #666666;
    }

    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0066cc;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .stat-item {
      background-color: #f9f9f9;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #666666;
    }

    .issue-list {
      margin-top: 12px;
    }

    .issue-item {
      background-color: #f9f9f9;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .issue-info {
      flex: 1;
    }

    .issue-type {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .issue-count {
      font-size: 12px;
      color: #666666;
    }

    .recommendation-list {
      margin-top: 12px;
    }

    .recommendation-item {
      background-color: #f0f0f0;
      border-radius: 4px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
    }

    .recommendation-item::before {
      content: 'ğŸ’¡';
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âœ¨ Figma PureRef</h1>
    
    <!-- æ–‡ä»¶åˆ†æ -->
    <div class="section">
      <h2>æ–‡ä»¶åˆ†æ</h2>
      <button class="btn" onclick="analyzeFile()">åˆ†æå½“å‰æ–‡ä»¶</button>
      <div id="analysis-results" style="margin-top: 16px;"></div>
    </div>

    <!-- æ¸…ç†å·¥å…· -->
    <div class="section">
      <h2>æ¸…ç†å·¥å…·</h2>
      <p style="font-size: 13px; color: #666666; margin-bottom: 12px;">é€‰æ‹©è¦æ‰§è¡Œçš„æ¸…ç†æ“ä½œ</p>
      <div class="cleanup-grid" id="cleanup-types"></div>
      <div class="button-group" style="margin-top: 16px;">
        <button class="btn btn-danger" onclick="runCleanupAll()">æ‰§è¡Œå…¨éƒ¨æ¸…ç†</button>
      </div>
    </div>

    <!-- é‡æ„å·¥å…· -->
    <div class="section">
      <h2>é‡æ„å·¥å…·</h2>
      <p style="font-size: 13px; color: #666666; margin-bottom: 12px;">é€‰æ‹©è¦æ‰§è¡Œçš„é‡æ„æ“ä½œ</p>
      <div class="refactor-grid" id="refactor-options"></div>
    </div>

    <!-- æ€§èƒ½ä¼˜åŒ– -->
    <div class="section">
      <h2>æ€§èƒ½ä¼˜åŒ–</h2>
      <button class="btn" onclick="optimizePerformance()">ä¼˜åŒ–æ€§èƒ½</button>
      <div id="performance-results" style="margin-top: 16px;"></div>
    </div>

    <!-- å¤‡ä»½ä¸æ¢å¤ -->
    <div class="section">
      <h2>å¤‡ä»½ä¸æ¢å¤</h2>
      <div class="button-group">
        <button class="btn" onclick="createBackup()">åˆ›å»ºå¤‡ä»½</button>
        <button class="btn btn-secondary" onclick="restoreBackup()">æ¢å¤å¤‡ä»½</button>
      </div>
    </div>

    <!-- æ“ä½œç»“æœ -->
    <div class="section">
      <h2>æ“ä½œç»“æœ</h2>
      <div id="operation-results"></div>
    </div>
  </div>

  <script>
    // æ¸…ç†ç±»å‹æ•°æ®
    const cleanupTypes = [
      {
        id: '1',
        name: 'ç©ºå›¾å±‚',
        description: 'åˆ é™¤æ‰€æœ‰ç©ºçš„å›¾å±‚å’Œæ¡†æ¶',
        severity: 'low',
        type: 'EMPTY_LAYERS'
      },
      {
        id: '2',
        name: 'éšè—å›¾å±‚',
        description: 'åˆ é™¤æ‰€æœ‰éšè—çš„å›¾å±‚',
        severity: 'medium',
        type: 'HIDDEN_LAYERS'
      },
      {
        id: '3',
        name: 'æœªä½¿ç”¨ç»„ä»¶',
        description: 'åˆ é™¤æœªè¢«ä½¿ç”¨çš„ç»„ä»¶',
        severity: 'high',
        type: 'UNUSED_COMPONENTS'
      },
      {
        id: '4',
        name: 'é‡å¤æ ·å¼',
        description: 'åˆå¹¶é‡å¤çš„æ ·å¼',
        severity: 'medium',
        type: 'DUPLICATE_STYLES'
      },
      {
        id: '5',
        name: 'å­¤ç«‹èŠ‚ç‚¹',
        description: 'åˆ é™¤æ²¡æœ‰çˆ¶èŠ‚ç‚¹çš„å­¤ç«‹å…ƒç´ ',
        severity: 'low',
        type: 'ORPHAN_NODES'
      },
      {
        id: '6',
        name: 'é›¶å°ºå¯¸å…ƒç´ ',
        description: 'åˆ é™¤å®½é«˜ä¸º0çš„å…ƒç´ ',
        severity: 'low',
        type: 'ZERO_SIZE_ELEMENTS'
      }
    ];

    // é‡æ„é€‰é¡¹æ•°æ®
    const refactorOptions = [
      {
        id: '1',
        name: 'é‡å‘½åå›¾å±‚',
        description: 'æ ¹æ®ç±»å‹å’Œå†…å®¹é‡å‘½åå›¾å±‚',
        type: 'RENAME_LAYERS'
      },
      {
        id: '2',
        name: 'ç»„ç»‡ç»“æ„',
        description: 'æŒ‰é€»è¾‘ç»„ç»‡å›¾å±‚ç»“æ„',
        type: 'ORGANIZE_STRUCTURE'
      },
      {
        id: '3',
        name: 'åˆ›å»ºç»„ä»¶',
        description: 'å°†é‡å¤å…ƒç´ è½¬æ¢ä¸ºç»„ä»¶',
        type: 'CREATE_COMPONENTS'
      },
      {
        id: '4',
        name: 'ç»Ÿä¸€æ ·å¼',
        description: 'ç»Ÿä¸€ç›¸ä¼¼å…ƒç´ çš„æ ·å¼',
        type: 'UNIFY_STYLES'
      },
      {
        id: '5',
        name: 'ä¼˜åŒ–å›¾ç‰‡',
        description: 'ä¼˜åŒ–å›¾ç‰‡è´¨é‡å’Œå°ºå¯¸',
        type: 'OPTIMIZE_IMAGES'
      },
      {
        id: '6',
        name: 'æ¸…ç†æ–‡æœ¬',
        description: 'æ¸…ç†æ–‡æœ¬æ ·å¼å’Œæ ¼å¼',
        type: 'CLEANUP_TEXT'
      }
    ];

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      renderCleanupTypes();
      renderRefactorOptions();
    });

    // æ¸²æŸ“æ¸…ç†ç±»å‹
    function renderCleanupTypes() {
      const typesContainer = document.getElementById('cleanup-types');
      typesContainer.innerHTML = cleanupTypes.map(type => `
        <div class="cleanup-card" onclick="runCleanup('${type.type}')">
          <div class="cleanup-name">${type.name}</div>
          <div class="cleanup-description">${type.description}</div>
          <div class="severity-badge severity-${type.severity}">${type.severity === 'high' ? 'é«˜' : type.severity === 'medium' ? 'ä¸­' : 'ä½'}ä¼˜å…ˆçº§</div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“é‡æ„é€‰é¡¹
    function renderRefactorOptions() {
      const optionsContainer = document.getElementById('refactor-options');
      optionsContainer.innerHTML = refactorOptions.map(option => `
        <div class="refactor-card" onclick="applyRefactor('${option.type}')">
          <div class="refactor-name">${option.name}</div>
          <div class="refactor-description">${option.description}</div>
        </div>
      `).join('');
    }

    // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶ä»£ç 
    function sendMessage(type, data = {}) {
      parent.postMessage({ pluginMessage: { type, ...data } }, '*');
    }

    // åˆ†ææ–‡ä»¶
    function analyzeFile() {
      const resultsDiv = document.getElementById('analysis-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ†ææ–‡ä»¶...</div>';
      sendMessage('analyze-file');
    }

    // è¿è¡Œæ¸…ç†
    function runCleanup(cleanupType) {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ‰§è¡Œæ¸…ç†...</div>';
      sendMessage('run-cleanup', { cleanupType });
    }

    // è¿è¡Œå…¨éƒ¨æ¸…ç†
    function runCleanupAll() {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ‰§è¡Œå…¨éƒ¨æ¸…ç†...</div>';
      sendMessage('run-cleanup-all');
    }

    // åº”ç”¨é‡æ„
    function applyRefactor(refactorType) {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åº”ç”¨é‡æ„...</div>';
      sendMessage('apply-refactor', { refactorType });
    }

    // ä¼˜åŒ–æ€§èƒ½
    function optimizePerformance() {
      const resultsDiv = document.getElementById('performance-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨ä¼˜åŒ–æ€§èƒ½...</div>';
      sendMessage('optimize-performance');
    }

    // åˆ›å»ºå¤‡ä»½
    function createBackup() {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ›å»ºå¤‡ä»½...</div>';
      sendMessage('create-backup');
    }

    // æ¢å¤å¤‡ä»½
    function restoreBackup() {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ¢å¤å¤‡ä»½...</div>';
      sendMessage('restore-backup');
    }

    // å¤„ç†æ¥è‡ªæ’ä»¶ä»£ç çš„æ¶ˆæ¯
    onmessage = (event) => {
      const { type, ...data } = event.data.pluginMessage;
      
      switch (type) {
        case 'file-analyzed':
          handleFileAnalyzed(data);
          break;
        case 'cleanup-completed':
        case 'cleanup-all-completed':
        case 'refactor-applied':
        case 'backup-created':
        case 'backup-restored':
          handleStatusMessage(data.message);
          break;
        case 'performance-optimized':
          handlePerformanceOptimized(data);
          break;
        case 'error':
          handleErrorMessage(data.message);
          break;
      }
    };

    // å¤„ç†æ–‡ä»¶åˆ†æç»“æœ
    function handleFileAnalyzed(data) {
      const resultsDiv = document.getElementById('analysis-results');
      const analysis = data.analysis;
      
      let html = `<div class="status-message">${data.message}</div>`;
      
      // ç»Ÿè®¡ä¿¡æ¯
      html += '<h3 style="font-size: 14px; margin: 16px 0 8px;">æ–‡ä»¶ç»Ÿè®¡:</h3>';
      html += '<div class="stats-grid">';
      html += `
        <div class="stat-item">
          <div class="stat-value">${analysis.totalLayers}</div>
          <div class="stat-label">æ€»å›¾å±‚æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${analysis.totalComponents}</div>
          <div class="stat-label">ç»„ä»¶æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${analysis.totalStyles}</div>
          <div class="stat-label">æ ·å¼æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${analysis.totalImages}</div>
          <div class="stat-label">å›¾ç‰‡æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${analysis.fileSize}</div>
          <div class="stat-label">æ–‡ä»¶å¤§å°</div>
        </div>
      `;
      html += '</div>';
      
      // é—®é¢˜åˆ—è¡¨
      if (analysis.issues && analysis.issues.length > 0) {
        html += '<h3 style="font-size: 14px; margin: 16px 0 8px;">å‘ç°çš„é—®é¢˜:</h3>';
        html += '<div class="issue-list">';
        analysis.issues.forEach(issue => {
          const severityClass = issue.severity === 'high' ? 'severity-high' : issue.severity === 'medium' ? 'severity-medium' : 'severity-low';
          html += `
            <div class="issue-item">
              <div class="issue-info">
                <div class="issue-type">${issue.type}</div>
                <div class="issue-count">${issue.count} ä¸ª</div>
              </div>
              <div class="severity-badge ${severityClass}">${issue.severity === 'high' ? 'é«˜' : issue.severity === 'medium' ? 'ä¸­' : 'ä½'}</div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      // æ¨èå»ºè®®
      if (analysis.recommendations && analysis.recommendations.length > 0) {
        html += '<h3 style="font-size: 14px; margin: 16px 0 8px;">æ¨èå»ºè®®:</h3>';
        html += '<div class="recommendation-list">';
        analysis.recommendations.forEach(recommendation => {
          html += `<div class="recommendation-item">${recommendation}</div>`;
        });
        html += '</div>';
      }
      
      resultsDiv.innerHTML = html;
    }

    // å¤„ç†æ€§èƒ½ä¼˜åŒ–ç»“æœ
    function handlePerformanceOptimized(data) {
      const resultsDiv = document.getElementById('performance-results');
      const optimizations = data.optimizations;
      
      let html = `<div class="status-message">${data.message}</div>`;
      html += '<h3 style="font-size: 14px; margin: 16px 0 8px;">ä¼˜åŒ–ç»“æœ:</h3>';
      html += '<div class="stats-grid">';
      html += `
        <div class="stat-item">
          <div class="stat-value">${optimizations.imagesOptimized}</div>
          <div class="stat-label">ä¼˜åŒ–å›¾ç‰‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${optimizations.stylesMerged}</div>
          <div class="stat-label">åˆå¹¶æ ·å¼</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${optimizations.layersSimplified}</div>
          <div class="stat-label">ç®€åŒ–å›¾å±‚</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${optimizations.memorySaved}</div>
          <div class="stat-label">èŠ‚çœå†…å­˜</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${optimizations.loadTimeImproved}</div>
          <div class="stat-label">åŠ è½½æ—¶é—´æ”¹å–„</div>
        </div>
      `;
      html += '</div>';
      
      resultsDiv.innerHTML = html;
    }

    // å¤„ç†çŠ¶æ€æ¶ˆæ¯
    function handleStatusMessage(message) {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = `<div class="status-message">${message}</div>`;
    }

    // å¤„ç†é”™è¯¯æ¶ˆæ¯
    function handleErrorMessage(message) {
      const resultsDiv = document.getElementById('operation-results');
      resultsDiv.innerHTML = `<div class="error-message">${message}</div>`;
    }
  </script>
</body>
</html>
